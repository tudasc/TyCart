macro(pythonize_bool truth_var var)
  if(${truth_var})
    set(${var} True)
  else()
    set(${var} False)
  endif()
endmacro()

function(configure_tycart_lit_site_cfg input output)
#  set(TYPEARTPASS_PROJECT_DIR ${PROJECT_SOURCE_DIR})
#  set(TYPEARTPASS_BINARY_DIR ${CMAKE_BINARY_DIR})
#  set(TYPEARTPASS_SCRIPT_DIR ${CMAKE_BINARY_DIR}/scripts)
#  set(TYPEARTPASS_LIBRARY_DIR ${CMAKE_BINARY_DIR}/lib/passes)
#  set(TYPEARTPASS_BASE_LIBRARY_DIR ${CMAKE_BINARY_DIR}/lib)
#  set(TYPEARTPASS_RT_DIR ${CMAKE_BINARY_DIR}/lib/runtime)

  set(TYCART_PROJECT_DIR ${PROJECT_SOURCE_DIR})
  set(TYCART_BASE_LIBRARY_DIR ${CMAKE_BINARY_DIR}/lib)
  set(TYCART_PASS_DIR ${TYCART_BASE_LIBRARY_DIR}/pass)
  set(TYCART_RT_DIR ${TYCART_BASE_LIBRARY_DIR}/runtime)
  set(TYCART_SCRIPT_DIR ${CMAKE_BINARY_DIR}/scripts)

  set(LIT_SITE_CFG_IN_HEADER
      "## Autogenerated by TyCart generation from ${input}\n## Do not edit!"
  )

  target_generate_file(${input} ${output})
endfunction()

configure_tycart_lit_site_cfg(
  ${CMAKE_CURRENT_SOURCE_DIR}/lit.site.cfg.in
  ${CMAKE_CURRENT_BINARY_DIR}/lit.site.cfg
)

set(TYCART_TEST_DEPENDS tycart::TransformPass tycart::Runtime)

add_lit_testsuite(lit-tycart-test
  "Running the TyCart tests"
  ${CMAKE_CURRENT_SOURCE_DIR}
  ARGS -v -j 1
  PARAMS tycart_site_config=${CMAKE_CURRENT_BINARY_DIR}/lit.site.cfg
  DEPENDS ${TYCART_TEST_DEPENDS}
)

add_test(
  NAME ctest_tycart_lit_suite
  COMMAND
    ${LLVM_LIT_PATH} -j 1 --param
    tycart_site_config=${CMAKE_CURRENT_BINARY_DIR}/lit.site.cfg
    ${CMAKE_CURRENT_SOURCE_DIR}
)

add_format_target(
  format-tycart-tests "Formats project test files"
  TARGETS *.c *.cpp *.h
)

if(TYCART_TEST_CONFIGURE_IDE)
  function(add_test_target_ide target header sources)
    add_executable(${target} EXCLUDE_FROM_ALL ${header} ${sources})

    add_dependencies(${target} ${TYCART_TEST_DEPENDS})

    target_include_directories(
      ${target} PRIVATE ${PROJECT_SOURCE_DIR}/lib/pass
                        ${PROJECT_SOURCE_DIR}/lib/runtime
                        ${PROJECT_SOURCE_DIR}
    )
  endfunction()

  file(GLOB_RECURSE TYCART_CXX_TESTS CONFIGURE_DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/*.cpp)
  file(GLOB_RECURSE TYCART_CC_TESTS CONFIGURE_DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/*.c)
  file(GLOB_RECURSE TYCART_TEST_HEADER CONFIGURE_DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/*.h)

  add_test_target_ide(
    tycart_cxx_test_objects "${TYCART_TEST_HEADER}" "${TYCART_CXX_TESTS}"
  )
  set_target_properties(tycart_cxx_test_objects PROPERTIES LINKER_LANGUAGE CXX)

  add_test_target_ide(tycart_cc_test_objects "${TYCART_TEST_HEADER}" "${TYCART_CC_TESTS}")
  set_target_properties(tycart_cc_test_objects PROPERTIES LINKER_LANGUAGE C)
endif()
