import os
import lit.util
import lit.formats

# From libcxx lit: Tell pylint that we know config and lit_config exist somewhere.
if 'PYLINT_IMPORT' in os.environ:
    config = object()
    lit_config = object()

config.name = "TycartTest"

loaded_site_cfg = getattr(config, 'loaded_site_config', False)
if not loaded_site_cfg:
  # Check for 'tycart_site_config' user parameter, and use that if available.
  site_cfg = lit_config.params.get('tycart_site_config', None)
  if site_cfg and os.path.exists(site_cfg):
    lit_config.load_config(config, site_cfg)
    raise SystemExit

config.test_format = lit.formats.ShTest(execute_external=True)
config.suffixes = ['.c','.cpp']
config.excludes = ['Inputs']

tycart_base_lib_dir = getattr(config, 'tycart_base_lib_dir', None)
tycart_pass_root    = getattr(config, 'tycart_pass_dir', None)
tycart_rt_root      = getattr(config, 'tycart_rt_dir', None)
transform_name      = getattr(config, 'tycart_pass', None)

typeart_transform_pass = getattr(config, 'typeart_pass', None)
typeart_analysis_pass  = getattr(config, 'typeart_analysis_pass', None)
typeart_std_args       = '-typeart'

transform_pass      = '{}/{}'.format(tycart_pass_root, transform_name)
std_plugin_args     = '-tycart'
to_llvm_args        = '-O1 -Xclang -disable-llvm-passes -S -emit-llvm -o -'
type_file           = 'types.yaml'

# Substitutions: executables use "-" separator, variables use underscore
config.substitutions.append(('%base_lib_path', tycart_base_lib_dir))
config.substitutions.append(('%pass_path', tycart_pass_root))
config.substitutions.append(('%runtime_path', tycart_rt_root))

config.substitutions.append(('%type_file', type_file))

config.substitutions.append(('%transform_plugin', transform_name))
config.substitutions.append(('%transform_pass', transform_pass))

config.substitutions.append(('%arg_std', std_plugin_args))

config.substitutions.append(('%apply-tycart', 'opt -load {} {}'.format(transform_pass, std_plugin_args)))
config.substitutions.append(('%c-to-llvm', 'clang {}'.format(to_llvm_args)))
config.substitutions.append(('%cpp-to-llvm', 'clang++ {}'.format(to_llvm_args)))

#config.substitutions.append(('%apply-typeart-tycart', 'opt -load {} -load {} {} | opt -load {} {}'.format(typeart_analysis_pass, typeart_transform_pass,typeart_std_args, transform_pass, std_plugin_args)))
config.substitutions.append(('%apply-typeart', 'opt -load {} -load {} {}'.format(typeart_analysis_pass, typeart_transform_pass, typeart_std_args)))